<!--

* Wraps the-graph-thumb with a current view bounding box
* Observes changes from attached instance of the-graph-editor

-->

<link rel="import" href="../the-graph-thumb/the-graph-thumb.html">

<dom-module id="the-graph-nav" attributes="width height editor hide" touch-action="none">
  <template>
    <style>
      #thumb,
      #outcanvas {
        position: absolute;
        top: 0;
        left: 0;
        overflow: visible;
      }

      #viewrect {
        position: absolute;
        top: 0;
        left: 0;
        width: 200px;
        height: 150px;
        border: 1px solid hsla(190, 100%, 80%, 0.4);
        border-style: dotted;
      }
    </style>
    <the-graph-thumb id="thumb" graph="{{ editor.fbpGraph }}" thumbrectangle="{{thumbrectangle}}" width="{{width}}" height="{{height}}"
      thumbscale="{{thumbscale}}" hide="{{hide}}" theme="{{ editor.theme }}">
    </the-graph-thumb>
    <canvas id="outcanvas" width="{{width}}" height="{{height}}" style="position:absolute;top:0;left:0;"></canvas>
    <div id="viewrect"></div>
  </template>
  <script>
    class TheGraphNav extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return 'the-graph-nav'
      }

      static get properties() {
        return {
          width: {
            type: Number,
            value: 200
          },
          height: {
            type: Number,
            value: 150
          },
          hide: {
            type: Boolean,
            value: false
          },
          thumbscale: {
            type: Number,
            value: 1
          },
          backgroundColor: {
            type: String,
            value: "hsla(184, 8%, 75%, 0.9)"
          },
          outsideFill: {
            type: String,
            value: "hsla(0, 0%, 0%, 0.4)"
          }
        }
      }

      // static get observers() {
      //   return [
      //     'editorScaleChanged(editorScale)',
      //   ];
      // }
      // observe: {
      //   'editor.scale': 'editorScaleChanged',
      //   'editor.width': 'editorWidthChanged',
      //   'editor.height': 'editorHeightChanged',
      //   'editor.pan': 'editorPanChanged',
      //   'editor.theme': 'editorThemeChanged'
      // }

      constructor() {
        super()
        this.log('created')
      }

      log(...args) {
        console.log('the-graph-nav', ...args)
      }

      // ready() {
      //   super.ready()
      //   this.log('ready')
      // }

      connectedCallback() {
        super.connectedCallback();
        this.log('connectedCallback')

        this.viewrectangle = [0, 0, 500, 500];
        this.scaledviewrectangle = [0, 0, 200, 150];
        this.theme = "dark";

        this.style.overflow = "hidden";
        this.style.cursor = "move";
        this.style.width = this.width + "px";
        this.style.height = this.height + "px";

        // HACK way to make PolymerGestures work for now
        var noop = function (event) {
          console.log('some gesture', event)
        };

        console.log('GraphNav: set up event listeners')
        // if (PolymerGestures) {
        //   PolymerGestures.addEventListener(this, "track", noop);
        //   PolymerGestures.addEventListener(this, "trackend", noop);
        //   PolymerGestures.addEventListener(this, "tap", noop);
        // } else {
        //   console.log('no PolymerGestures to add events on')
        // }

        if (Polymer.Gestures) {
          this.log('Polymer 2 Gestures! noop')
          Polymer.Gestures.addListener(this, 'track', noop);
          Polymer.Gestures.addListener(this, 'trackend', noop);
          Polymer.Gestures.addListener(this, 'tap', noop);
        } else {
          this.log('missing Polymer.Gestures')
        }

        // Pan graph by dragging map
        this.addEventListener("track", (event) => {
          console.log('track: pan graph by dragging', event)
          if (!this.editor) {
            return;
          }
          // Don't pan graph
          event.stopPropagation();

          var x = this.editor.pan[0];
          var y = this.editor.pan[1];
          var panscale = this.thumbscale / this.editor.scale;
          x -= event.ddx / panscale;
          y -= event.ddy / panscale;
          this.editor.pan = [Math.round(x), Math.round(y)];

          event.preventTap();
        });

        this.addEventListener("trackend", (event) => {
          console.log('trackend: pan graph by dragging', event)
          // Don't pan graph
          event.stopPropagation();
        });

        // Tap to fit
        this.addEventListener("tap", function () {
          console.log('tap: nav', event)
          if (!this.editor) {
            return;
          }
          this.editor.triggerFit();
        });
      }

      editorChanged(editor, newEditor) {

      }

      editorPanChanged() {
        if (!this.editor.pan) {
          return;
        }
        var x = this.editor.pan[0];
        var y = this.editor.pan[1];

        this.viewrectangle[0] = -x;
        this.viewrectangle[1] = -y;
      }
      editorWidthChanged() {
        this.viewrectangle[2] = parseInt(this.editor.width, 10);
      }
      editorHeightChanged() {
        this.viewrectangle[3] = parseInt(this.editor.height, 10);
      }
      editorScaleChanged() {
        this.scale = this.editor.scale;
      }
      editorThemeChanged() {
        var style = TheGraph.nav.calculateStyleFromTheme(this.theme);
        this.backgroundColor = style.backgroundColor;
        this.viewBoxBorder = style.viewBoxBorder;
        this.viewBoxBorder2 = style.viewBoxBorder2;
        this.outsideFill = style.outsideFill;
        this.style.backgroundColor = this.backgroundColor;
        // Redraw rectangle
        this.viewrectangleChanged();
      }
      viewrectangleChanged() {
        // Canvas to grey out outside view
        var context = this.$.outcanvas.getContext('2d');
        context = unwrap(context);

        var properties = {
          width: this.width,
          height: this.height,
          scale: this.scale,
          thumbscale: this.thumbscale,
          thumbrectangle: this.thumbrectangle,
          viewrectangle: this.viewrectangle,
          viewBoxBorder: this.viewBoxBorder,
          viewBoxBorder2: this.viewBoxBorder2,
          outsideFill: this.outsideFill,
        };
        var nav = TheGraph.nav.render(context, this.$.viewrect, properties);
        this.hide = nav.hide;
        // this.scaledviewrectangle = [x, y, w, h];
      }
      hideChanged() {
        if (this.hide) {
          this.style.display = "none";
        } else {
          this.style.display = "block";
        }
      }
      thumbscaleChanged() {
        this.viewrectangleChanged();
      }
      thumbrectangleChanged() {
        // Binding this from the-graph-thumb to know the dimensions rendered
        var w = this.thumbrectangle[2];
        var h = this.thumbrectangle[3];
        this.thumbscale = (w > h) ? this.width / w : this.height / h;
      }
    }
    window.customElements.define(TheGraphNav.is, TheGraphNav);
  </script>
  </polymer-element>